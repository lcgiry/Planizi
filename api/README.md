# Planizi API

## Installation
### Overview
The API project is developped with **NodeJS** and Express module.  
The database used is **MySQL** with Sequelize module as ORM.

### Set up your development environment
#### Dowload NodeJS and the project
- [ ] Dowload and open your IDE as IntelliJ or Webstorm (optionally)  
- [ ] If not yet, dowload **NodeJS** and **npm**, then update your PATH variable. Make sure with the commands :  
`node --version`
`npm --version`
- [ ] Clone the project on your workspace :  
`git clone https://github.com/lcgiry/Planizi.git`

#### Dowload dependencies and frameworks
- [ ] As all dependencies and frameworks come from npm packages, you can install all by using the following command :  
`npm install`

#### Provision the database
- [ ] Dowload MySQL Server (and optionally MySQL Workbench for the GUI).  
- [ ] Import the latest database dump (.sql) available in ***./database_dump/*** directory.  
  `mysql -p -u [user] [database] < planizi_database_dump_[date].sql`  
  That will create and provision the database named *db_planizi*.  
- [ ] Start MySQL Server. It will listen on port 3306.  

### Start the application
- Lauch the application server with the command :   
`npm start`  
- Open your browser and go at http://localhost:8080/


## Project Architecture
### File architecture
 ````$xslt
|-- bin                                                         //Start file
|   |-- www.js
|
|-- config                                                      //All configuration files
|   |-- authentication
|       |-- config-authentication.json
|       |-- config-authentication.js
|   |-- database
|       |-- config-database.json
|       |-- config-database.js
|
|-- database-dump                                               //To store dump of the db recurrently
|   |-- planizi_database_dump_date.sql
|
|-- doc                                                         //The documentation generated by apidoc module
|
|-- models                                                      //All models configuration to link database and code (Sequelize ORM code)
|   |-- user.js
|   |-- task.js
|   |-- ...
|   |-- ...
|   |-- team.js
|
|-- node_modules                                                //The default package that store all node modules
|   |-- ...
|
|-- routes                                                      //All routes defined to respond to incoming API requests
|   |-- index.js
|   |-- registration.js
|   |-- ...
|
|-- package-lock.json
|-- package.json
|-- app.js                                                      //The first entrypoint when the application server in lauched (after bin/www)
|-- Readme.md
```` 
 
 
## API routing : *Express* module
### Overview
Thanks to *Express*, we can create and launch a webserver. This one will respond to external requests as a classical webserver.   
We will defined all the routes with an organized "path architecture" to respond to each request. According to the request path, the request method and the request parameters passed,
that server will respond to the client (who has sent the request) with object or informations.

### Middleware and promises
##### Middlewares
Before starting it's important to understand what Middleware are.
First, we can say that the express application (the API) is represented by ``app`` variable.   
Middleware are functions that will be in the middle between the application and incoming requests.
For example, there are middlewares to parse the incoming request body, to encode URL, to store session,... It exists so many middleware (modules)
to simplify our work and make some ingrateful tasks.   
To use a middleware you have to import it and to add it to the application with the command ``app.use()``.
The middlewares are executed one after the other, so take care to the order.

##### Promises
Before starting it's also important to understand what Promises are.
To sum up, promises are value that will be available in the future.
A promise can be resolved or rejected. If it's resolved, the value become available and can be treated in then() clause,
otherwise an error or other object are sent to catch().

### Routes
#### Declare the main routes
In ``app.js``, first, you must declare all main routes that will be implemented in ``/routes/`` :   
````javascript
var fileRouteRouter = require('./routes/fileRoute');
app.use("/pathToRoute", fileRouteRouter);
````
Thus, all request whose the path start with ``/pathToRoute`` will be forwarded and handled by ``fileRoute``.
 
#### Handle requests
The requests must be handled in ``/routes/`` directory in a particular file.   
Each request will be catch by the appropriate function according to its path and method.
````javascript
var router = express.Router();

router.get('/mail/:id', function(req, res, next) {
    //Here the instruction to do when client make GET request to /pathToRoute/mail/id where id is the parameter
    //After that a response must be sent to the client
});

router.post('/mail/', function(req, res, next) {
    //Here the instructions to do (insert new user in db).
    //After that a response must be sent to the client.
});

module.exports = router;
````

## ORM and models : *Sequelize* module
### Overview
Consult the official documentation that's very useful: http://docs.sequelizejs.com.  
Sequelize enable Database mapping. That's to say all table are mapped on the Node code thank's to object instantiate by Sequelize.
All accesses to the database will be performed with Sequelize.

### Architecture and database link
The configuration link is very simple and set with database configuration in ``/config/database/config-database``.  
Each table of the database is defined as a model in ``/models/[table_name].js``.  
When you add a new table or a new field of an existing table of the database, you have to alter the corresponding models. Refer to an existing one to create a new model or a new field. Take care to have a good mapping between the model and the table, otherwise errors will occur.  
You can generate theses models by using ``sequelize-auto`` module with the command:  
``node ./node_modules/sequelize-auto/bin/sequelize-auto -h localhost -d db_planizi -u [user] -x [password]
``

### Make queries
Refer to documentation: http://docs.sequelizejs.com/manual/tutorial/models-usage.html and http://docs.sequelizejs.com/manual/tutorial/querying.html.  
Note that Sequelize uses promises that return an instance of an object defined by the appropriate model (if no error). For example :
````javascript
//Import UserModel, sequelize and all necessary modules

UserModel.findAll({where: {id: userId}})                                //You can make some types of query (findAll, findOne, findAndCount, ... with some clauses) 
    .then(userResult => {                                               //userResult is an instance of the object defined in /models/UserModel.js
    	console.log('user found : '+ userResult.name);
    })
    .catch(err =>{
    	console.log('error : '+err);
    });
```` 

### Object instance and inserts
You can create an object instance defined in /models/ to prepare an entry that could be insert in the database.
````javascript
const userInstance = UserModel.build({
        id: userId
        name: userName,
        surname: userSurname
    });

console.log(userInstance.surname);

userInstance.save()                                 //To insert in database
    .then( ()=>{} )
    .catch( err=>{} );
```` 

## Other modules
### Authentication with *Passport* module and OAuth2

## Documentation
### Generate documentation
``apidoc -i routes/ -o doc/``

### Add documentation